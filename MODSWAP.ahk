;======[ Crappy Generals Online Mod Loader]======;
;                                                                                         .           
; +++++++++++++++++++++====+++++====++++++++++++++++++++++++++=++++++++*++++++++++=====++=+++=++++++ 
; +++++++++++++++++++++=+++++====+==========+===++====++=====++++++++++==+++++++==+=+========+==++++ 
; ++++++++++++=+++++++++++++================+==================+++++++++++++=+====+==+=+++++=+++++=+ 
; ++=+++++++++++++++++============================-==============+++++=+++=======++==========+=+++++ 
; +*+++=++++++++++++++++==============++++=+====+==+=========+++++++++++++++=================++++++= 
; +++++++++++++++++++++===::-========:.:-=========-:-=======--:-=====+=====-===============+++++++++.
; +++++++++++++++++++=====*@:-======--#=.-=+==+=+:.@+:====+=--%=-=====--=+++===========-===++=++++++ 
; ++=+++++++++++++===++====@@ .=====-:@@. ....  . .@::-==---.%@--=-==::*=:======-==--==+++==++++++=+ 
; ++++++==++=+=++-+=..=+==.=@@ .-:     =%:=:-===++@@  .      *+ .-=+-.@@----===========++++++=++++++ 
; +++=====++=+==+-*@@=.=+=-  @@   %@@@@@@@@@@@@@@:.:*@@@@@@@@@@*+-.  =@. ----------=====++=+++++++++ 
; +++++=+=======+=:.#@# .::  .@@@@@@%@%#####*#%###%@+..........-*@@@@@*    ..  :=--===+==+=++=++++++ 
; ==+++++++++==-=. -..@@#  @@:.+*::=:......:+-:........::-------:.....-@@@#  #@@#===-+======++++++++ 
; ==+++*++++++=+@@* ..  %@@@@@@+:::::------=**##@@@@@@@@-...:-----=---:..:#@@=   :=+=-.-+===+++=++++ 
; =----====++==:.=@@%  @@@*.....----====---::::....   .-%@@%...::::---==--...@@*..:: -@@%-=++=+=++++ 
; =--:.  .-=+*++- . =#@%  ...:..:---------:.....:+*%@@@%#*%@@@%#+=-.....::--...@@#  @@*.:====+++=+== 
; +==-+@@=     ..-: .@@#%@@@@@%*...........=@@@@@@#*+-:::...:=*#%@@@@=+=. ..:-:.:@@@# .-==+=====++++ 
; ====:   :%@@@#=- *@@.......:-*%@@@@@@@@@@@....................... @@@@@@@  .-::.:@@- :===:.:-=+=== 
; ++++=-*@@@ :#@@:@@. :%*:.      @@%@%...:@@ .:-:=*@@@@=:-+#*+*%*. .@*   =@@@- .....:@@    +@@#=+++= 
; +====:%@@@     .@..@@  @@@@@@@@+.......=%@@- . #@%.  :@@@@@@+=@%%@@.:-:.  #@@@+..:..@@ +@@+.:====+ 
; +=++=-  *@@   -@. .=#%%#   %@....::..:+#%#%@@@@%#@@@@@@%++*@@@@%+..:-==--..  @@@+....@@%:.:-===+== 
; ==-:.::. +@@+=@@@@@@#=.%@@.   ..-=.+=.    ...-@* ................:-===--=---:..-@@%. :@  -=-===+++ 
; +=%@@#.    -@@%......*@@  @@@@@+:=-@@@@@@@:   @#.-=----=--=-==================-...@@# @@ +=-====== 
; +=-:=@@@@#+@@...----::.@@@#++=..--:.. ..#@@@@@@=:-=======-==---======-=-======---:..@@@@  :=====+= 
; ===:     .@@..==-===-:...=***=.-====-.....--:...-========-==================--===-=:. @@%@%:-=====.
; ==-+@@.  %@..-==========:....:-======-=--:::--=-====================================:.@@..--====== 
; =-:..#@@@@..-==-============-=====================================================-=-.@@ .====-=== 
; -===-  .@*.---======================-=============================================-=-.@@ :*======= 
; ====-..@-.:-========-==-=================----==================-==================-=-.@*     :===- 
; :     -@..==-===--=-:..:--====-=============================================-=====-=:.@@@@@@%---== 
; +@@@@@*@@:.:=====--:.@@:-==========----=====================-:..-=-=================..@@     :--=- 
; -.      #@...:-===-.#@@.====--===--======================----+@*.+-===============--.=@@ .::--=--- 
; ====---. @@@-.:==-.%@-..------============---=---=----:....:::@@.----=============-:.=@@    .:--=- 
; ==:.:.-==@@@@..--::@+ *+:.............................-#@@@#..=@*--========-======:..@@@@@@@=:--=- 
; ==*@@@@@: *@@@..=.:@+.#@@@@@@@@@*+:.-+=+#+-+**%@@@@@@@@%=....-@@.-=========-=====:..@@     ::-==== 
; ==-.    .  :@@# .:.@@.......-#@@@@@@@@@@@@@@@@@@%#-.....::...@@..--============-:. @@@ .==-======= 
; ==========.  @@@...#@=-=---:.......... .  ........:-==-=-:.@@#..=+===========--:..@@@  :==+===++== 
; =========-.  =@@@...::==========---*@@@@@*-=============-=@@=.:-------=======-:..#@@%..======+===+.
; =====-:  .%@@. @@@...---==========--:...::-===--=-======-**:.:--.....:===-=--...@@@*   :-====+==== 
; ==-:..=%@@%:    @@@+.:--==-========---============--====--::--:..*@@%:===--.. @@@@  #@@-  :-====+= 
; -:-*@@@#: .-=+=  @@@. .....-======================-====--=--:. :@@@@.-==--. =@@@-  .  +@@@=:====== 
; *@@@+. .:-====. ++*@@= .@@...:---=========-==-========----:. -@@@+ .:--.. .@@@-   :---. :---+===== 
; -:...-=====-. =@@  @@@% +@@@. ...----======--=====--==-:.. .@@@= ..::.. =@@@- *@+  -==-:---=-=====.
; =========-. -@@- .  .@@@  +@@@@:   ...:::::---::--:...   @@@@  ..-:...@@@@*    .@@@. .--========== 
; =+======:.#@@= .=-=   @@@*   @@@@@@@+               :@@@@@@...::.. .@@@.    -=-:  #@@@=======-==== 
; ========+@@- .-===-::@  @@@.    .-@@@@@@@@@@@@@@@@@@@@@@......  .@@@@+#. .=-=--==-. :--=========== 
; ========:..:-===-- :@#   @@@@*..  ...  .   ...   .    .....  @@@@@     @@==========--============= 
;.+++===+=-=======-.#@# .:  .=@@@@@=.  ..............:...  .@@@@@ .   -:  .:--====================== 
; ======+==========@@+..---:   . .@@@@@@@@@@+.      ...*@@@@@%   @@= ::---=-=+=======+++++========== 
; =+==============-: .--=------..   .  -#@@@@@@@@@@@@@@@@..   ..:  @@ .-------================+=+=== 
; +======+==========--=-=-----==- %@: .                    .-=-==-. @@=---=---==============++====== 
; ============+=========-=====---.@* ---=--:-%%::---=:.@@==---=---=:...----=-=====================+= 
; ++++==+=========-==-====-==--==:-.=+=====--:.--===--: ..======-=--------==-========++=++++=====++= 
; ==++======================-=============================----===-=-=====--========================+ 
; ++=========================-=============================================================+++++==++ 
; +=+++++=========-===============================================================================+= 
; Main GUI for launching mods — AutoHotkey v2


#SingleInstance Force
#Requires AutoHotkey v2.0

IniFile := A_ScriptDir "\CGOML Files\INI\mods.ini"
activeModIni := A_ScriptDir "\CGOML Files\active_mod.ini"

; ==========================
; Load INI sections
; ==========================
content := FileRead(IniFile)
if (content = "")
{
    MsgBox("Cannot read mods.ini or file is empty")
    ExitApp
}

sections := []
for line in StrSplit(content, "`n")
{
    line := Trim(line)
    m := []
    if RegExMatch(line, "^\[(.+)\]$", &m)
        sections.Push(m[1])
}

; ==========================
; Read currently active mod
; ==========================
activeMod := ""
if FileExist(activeModIni)
    activeMod := IniRead(activeModIni, "State", "ActiveMod", "")

; ==========================
; Create GUI
; ==========================
CGOML := Gui(, "Mods GUI")
yPos := 10
btnMap := Map()
btnList := Map() ; headerName -> button

for headerName in sections
{
    modName := IniRead(IniFile, headerName, "name", "")
    if (modName = "")
        continue

    ; Highlight button if it's the active mod
    btnOptions := "x10 y" yPos " w200 h30"
    if (modName = activeMod)
        btnOptions .= " BackgroundGreen"

    btn := CGOML.Add("Button", btnOptions, modName)
    btnMap[btn] := headerName
    btnList[headerName] := btn

    ; Assign click event
    btn.OnEvent("Click", (thisBtn, *) => OnModClick(thisBtn, btnMap, btnList, activeModIni))

    ; Add text
    CGOML.Add("Text", "x220 y" yPos " w300 h30", "Play " modName " on Generals Online")

    yPos += 40
}

; ==========================
; Button click handler
; ==========================
OnModClick(btn, btnMap, btnList, activeModIni) {
    headerName := btnMap[btn]
    Run('"' A_ScriptDir '\CGOML Files\Sub Programs\RunMod.exe" "' headerName '"')

    ; Update button highlighting after launch
    for name, button in btnList {
        button.Opt("BackgroundDefault")
    }
    btn.Opt("BackgroundGreen")

    ; Save active mod right away (GUI stays in sync)
    IniWrite(IniRead(A_ScriptDir "\CGOML Files\INI\mods.ini", headerName, "name", ""), activeModIni, "State", "ActiveMod")
}

; ==========================
; Close event
; ==========================
CGOML.OnEvent("Close", (*) => ExitApp())

CGOML.Show()
Return
